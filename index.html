<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>露營報名表 v2.1.1</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  body { font-family: sans-serif; padding: 20px; max-width: 500px; margin: auto; background:#f9f9f9; }
  h2 { text-align:center; color:#333; }
  label { font-weight:bold; display:block; margin-bottom:6px; }
  .hint { font-size:12px; color:#555; margin-top:-8px; margin-bottom:10px; }
  input, select, textarea { display:block; width:100%; padding:8px; margin-bottom:14px; box-sizing:border-box; border:1px solid #ccc; border-radius:8px; }
  button { background:#4CAF50; color:#fff; padding:10px; border:none; border-radius:8px; cursor:pointer; width:100%; font-size:16px; }
  button:hover { background:#45a049; }
  #userName { margin-bottom:18px; font-weight:bold; color:green; text-align:center; }
</style>
</head>
<body>
  <h2>🏕️ 露營報名表 v2.1.1</h2>
  <div id="userName">🔄 載入中...</div>

  <form id="eventForm">
    <input type="text" id="name" name="name" placeholder="姓名（自動帶入）" readonly required>

    <label for="eventName">露營場次名稱</label>
    <select id="eventName" name="eventName" required>
      <option value="">請選擇場次</option>
      <option value="11/1-11/3 秋季露營">11/1-11/3 秋季露營</option>
      <option value="12/20-12/22 冬季聖誕露營">12/20-12/22 冬季聖誕露營</option>
    </select>

    <label for="adultCount">大人人數</label>
    <input type="number" id="adultCount" name="adultCount" min="0" value="0" required>

    <label for="halfPriceChildCount">半價小孩人數</label>
    <input type="number" id="halfPriceChildCount" name="halfPriceChildCount" min="0" value="0" required>
    <div class="hint">小1以上到高中，沒有則填 0</div>

    <label for="youngChildCount">幼稚園以下小孩人數</label>
    <input type="number" id="youngChildCount" name="youngChildCount" min="0" value="0" required>
    <div class="hint">沒有則填 0</div>

    <label for="nightAttack">是否夜衝</label>
    <select id="nightAttack" name="nightAttack" required>
      <option value="">請選擇</option>
      <option value="是">是</option>
      <option value="否">否</option>
    </select>

    <label for="note">備註 (將同時包含 LINE UserId)</label>
    <textarea id="note" name="note" placeholder="備註 (選填)"></textarea>

    <button type="submit">送出報名</button>
  </form>

<script>
/** 版本 2.1.1 **/
const LIFF_ID = "2008043659-x9g3OvbJ";           // <-- 換成你的 LIFF ID
const NOTION_API_KEY = "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";  // <-- 換成你的 Notion Integration Token
const DATABASE_ID = "20dcb700e2998160a3cdd8b0748c22af";   // <-- 換成你的 Notion Database ID

async function initLiffAndProfile() {
  await liff.init({ liffId: LIFF_ID });

  // 若未登入，觸發 LINE 登入頁面（使用者登入後會重新導回 LIFF）
  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  try {
    const profile = await liff.getProfile();
    document.getElementById("userName").textContent = `👤 目前登入者：${profile.displayName}`;
    document.getElementById("name").value = profile.displayName || "";
    // 暫存在 form 的 dataset 內，方便合併到備註
    document.getElementById("eventForm").dataset.userId = profile.userId || "";
  } catch (err) {
    document.getElementById("userName").textContent = "⚠️ 無法取得使用者資訊";
    console.error("liff.getProfile() error:", err);
  }
}

document.getElementById("eventForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const form = e.target;
  // 必填檢查：是否夜衝
  const nightVal = form.nightAttack.value;
  if (!nightVal) {
    alert("⚠️ 請選擇『是否夜衝』！");
    return;
  }

  // 取得欄位值（保護性處理）
  const name = (form.name.value || "").trim();
  const eventName = (form.eventName.value || "").trim();
  const adultCount = parseInt(form.adultCount.value, 10) || 0;
  const halfPriceChildCount = parseInt(form.halfPriceChildCount.value, 10) || 0;
  const youngChildCount = parseInt(form.youngChildCount.value, 10) || 0;
  const nightAttackBool = (nightVal === "是");
  const userNote = (form.note.value || "").trim();
  const userId = form.dataset.userId || "";

  // 合併備註：原備註 + 換行 + LINE UserId
  let combinedNote = userNote;
  if (combinedNote) combinedNote += "\n";
  combinedNote += `LINE UserId: ${userId}`;

  // 建立 Notion payload，請確保欄位名稱完全吻合 Notion Database
  const payload = {
    parent: { database_id: DATABASE_ID },
    properties: {
      "名字_M": {
        rich_text: [{ text: { content: name } }]
      },
      "場次": {
        rich_text: [{ text: { content: eventName } }]
      },
      "大人數_M(*1)": {
        number: adultCount
      },
      "小孩數_M(*0.5)": {
        number: halfPriceChildCount
      },
      "幼稚園小孩_M(*0)": {
        number: youngChildCount
      },
      "是否夜衝_M": {
        checkbox: !!nightAttackBool
      },
      "備註": {
        rich_text: [{ text: { content: combinedNote } }]
      }
    }
  };

  try {
    const res = await fetch("https://api.notion.com/v1/pages", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${NOTION_API_KEY}`,
        "Content-Type": "application/json",
        "Notion-Version": "2022-06-28"
      },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      alert("✅ 報名成功！資料已寫入 Notion");
      // 關閉 LIFF 視窗（若在 LINE 裡）
      try { liff.closeWindow(); } catch (e) { /* ignore */ }
      return;
    }

    // 若非 ok，取得錯誤訊息協助除錯
    const errData = await res.json().catch(() => null);
    console.error("Notion API Error:", errData || res.statusText);
    // 友善回報給使用者
    const msg = (errData && errData.message) ? errData.message : "Notion API 回傳錯誤";
    alert("❌ 報名失敗：" + msg);

  } catch (err) {
    console.error("Fetch error:", err);
    alert("❌ 系統錯誤，請稍後再試！");
  }
});

// 啟動 LIFF
initLiffAndProfile();
</script>
</body>
</html>
