<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>éœ²ç‡Ÿå ±åè¡¨ v2.1.1</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  body { font-family: sans-serif; padding: 20px; max-width: 500px; margin: auto; background:#f9f9f9; }
  h2 { text-align:center; color:#333; }
  label { font-weight:bold; display:block; margin-bottom:6px; }
  .hint { font-size:12px; color:#555; margin-top:-8px; margin-bottom:10px; }
  input, select, textarea { display:block; width:100%; padding:8px; margin-bottom:14px; box-sizing:border-box; border:1px solid #ccc; border-radius:8px; }
  button { background:#4CAF50; color:#fff; padding:10px; border:none; border-radius:8px; cursor:pointer; width:100%; font-size:16px; }
  button:hover { background:#45a049; }
  #userName { margin-bottom:18px; font-weight:bold; color:green; text-align:center; }
</style>
</head>
<body>
  <h2>ğŸ•ï¸ éœ²ç‡Ÿå ±åè¡¨ v2.1.1</h2>
  <div id="userName">ğŸ”„ è¼‰å…¥ä¸­...</div>

  <form id="eventForm">
    <input type="text" id="name" name="name" placeholder="å§“åï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰" readonly required>

    <label for="eventName">éœ²ç‡Ÿå ´æ¬¡åç¨±</label>
    <select id="eventName" name="eventName" required>
      <option value="">è«‹é¸æ“‡å ´æ¬¡</option>
      <option value="11/1-11/3 ç§‹å­£éœ²ç‡Ÿ">11/1-11/3 ç§‹å­£éœ²ç‡Ÿ</option>
      <option value="12/20-12/22 å†¬å­£è–èª•éœ²ç‡Ÿ">12/20-12/22 å†¬å­£è–èª•éœ²ç‡Ÿ</option>
    </select>

    <label for="adultCount">å¤§äººäººæ•¸</label>
    <input type="number" id="adultCount" name="adultCount" min="0" value="0" required>

    <label for="halfPriceChildCount">åŠåƒ¹å°å­©äººæ•¸</label>
    <input type="number" id="halfPriceChildCount" name="halfPriceChildCount" min="0" value="0" required>
    <div class="hint">å°1ä»¥ä¸Šåˆ°é«˜ä¸­ï¼Œæ²’æœ‰å‰‡å¡« 0</div>

    <label for="youngChildCount">å¹¼ç¨šåœ’ä»¥ä¸‹å°å­©äººæ•¸</label>
    <input type="number" id="youngChildCount" name="youngChildCount" min="0" value="0" required>
    <div class="hint">æ²’æœ‰å‰‡å¡« 0</div>

    <label for="nightAttack">æ˜¯å¦å¤œè¡</label>
    <select id="nightAttack" name="nightAttack" required>
      <option value="">è«‹é¸æ“‡</option>
      <option value="æ˜¯">æ˜¯</option>
      <option value="å¦">å¦</option>
    </select>

    <label for="note">å‚™è¨» (å°‡åŒæ™‚åŒ…å« LINE UserId)</label>
    <textarea id="note" name="note" placeholder="å‚™è¨» (é¸å¡«)"></textarea>

    <button type="submit">é€å‡ºå ±å</button>
  </form>

<script>
/** ç‰ˆæœ¬ 2.1.1 **/
const LIFF_ID = "2008043659-x9g3OvbJ";           // <-- æ›æˆä½ çš„ LIFF ID
const NOTION_API_KEY = "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";  // <-- æ›æˆä½ çš„ Notion Integration Token
const DATABASE_ID = "20dcb700e2998160a3cdd8b0748c22af";   // <-- æ›æˆä½ çš„ Notion Database ID

async function initLiffAndProfile() {
  await liff.init({ liffId: LIFF_ID });

  // è‹¥æœªç™»å…¥ï¼Œè§¸ç™¼ LINE ç™»å…¥é é¢ï¼ˆä½¿ç”¨è€…ç™»å…¥å¾Œæœƒé‡æ–°å°å› LIFFï¼‰
  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  try {
    const profile = await liff.getProfile();
    document.getElementById("userName").textContent = `ğŸ‘¤ ç›®å‰ç™»å…¥è€…ï¼š${profile.displayName}`;
    document.getElementById("name").value = profile.displayName || "";
    // æš«å­˜åœ¨ form çš„ dataset å…§ï¼Œæ–¹ä¾¿åˆä½µåˆ°å‚™è¨»
    document.getElementById("eventForm").dataset.userId = profile.userId || "";
  } catch (err) {
    document.getElementById("userName").textContent = "âš ï¸ ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Š";
    console.error("liff.getProfile() error:", err);
  }
}

document.getElementById("eventForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const form = e.target;
  // å¿…å¡«æª¢æŸ¥ï¼šæ˜¯å¦å¤œè¡
  const nightVal = form.nightAttack.value;
  if (!nightVal) {
    alert("âš ï¸ è«‹é¸æ“‡ã€æ˜¯å¦å¤œè¡ã€ï¼");
    return;
  }

  // å–å¾—æ¬„ä½å€¼ï¼ˆä¿è­·æ€§è™•ç†ï¼‰
  const name = (form.name.value || "").trim();
  const eventName = (form.eventName.value || "").trim();
  const adultCount = parseInt(form.adultCount.value, 10) || 0;
  const halfPriceChildCount = parseInt(form.halfPriceChildCount.value, 10) || 0;
  const youngChildCount = parseInt(form.youngChildCount.value, 10) || 0;
  const nightAttackBool = (nightVal === "æ˜¯");
  const userNote = (form.note.value || "").trim();
  const userId = form.dataset.userId || "";

  // åˆä½µå‚™è¨»ï¼šåŸå‚™è¨» + æ›è¡Œ + LINE UserId
  let combinedNote = userNote;
  if (combinedNote) combinedNote += "\n";
  combinedNote += `LINE UserId: ${userId}`;

  // å»ºç«‹ Notion payloadï¼Œè«‹ç¢ºä¿æ¬„ä½åç¨±å®Œå…¨å»åˆ Notion Database
  const payload = {
    parent: { database_id: DATABASE_ID },
    properties: {
      "åå­—_M": {
        rich_text: [{ text: { content: name } }]
      },
      "å ´æ¬¡": {
        rich_text: [{ text: { content: eventName } }]
      },
      "å¤§äººæ•¸_M(*1)": {
        number: adultCount
      },
      "å°å­©æ•¸_M(*0.5)": {
        number: halfPriceChildCount
      },
      "å¹¼ç¨šåœ’å°å­©_M(*0)": {
        number: youngChildCount
      },
      "æ˜¯å¦å¤œè¡_M": {
        checkbox: !!nightAttackBool
      },
      "å‚™è¨»": {
        rich_text: [{ text: { content: combinedNote } }]
      }
    }
  };

  try {
    const res = await fetch("https://api.notion.com/v1/pages", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${NOTION_API_KEY}`,
        "Content-Type": "application/json",
        "Notion-Version": "2022-06-28"
      },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      alert("âœ… å ±åæˆåŠŸï¼è³‡æ–™å·²å¯«å…¥ Notion");
      // é—œé–‰ LIFF è¦–çª—ï¼ˆè‹¥åœ¨ LINE è£¡ï¼‰
      try { liff.closeWindow(); } catch (e) { /* ignore */ }
      return;
    }

    // è‹¥é okï¼Œå–å¾—éŒ¯èª¤è¨Šæ¯å”åŠ©é™¤éŒ¯
    const errData = await res.json().catch(() => null);
    console.error("Notion API Error:", errData || res.statusText);
    // å‹å–„å›å ±çµ¦ä½¿ç”¨è€…
    const msg = (errData && errData.message) ? errData.message : "Notion API å›å‚³éŒ¯èª¤";
    alert("âŒ å ±åå¤±æ•—ï¼š" + msg);

  } catch (err) {
    console.error("Fetch error:", err);
    alert("âŒ ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
  }
});

// å•Ÿå‹• LIFF
initLiffAndProfile();
</script>
</body>
</html>
