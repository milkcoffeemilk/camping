<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>露營活動報名表</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: sans-serif; padding: 20px; max-width: 500px; margin: auto; }
input, select, textarea { display: block; margin-bottom: 10px; width: 100%; padding: 8px; box-sizing: border-box; }
label { font-weight: bold; display: block; margin-bottom: 4px; }
.hint { font-size: 0.9em; color: gray; margin-top: -8px; margin-bottom: 8px; }
#userName { margin-bottom: 20px; font-weight: bold; color: green; text-align: center; }
.checkbox-group { display: flex; align-items: center; gap: 8px; }
button { padding: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%; }
button:hover { background-color: #45a049; }
</style>
</head>
<body>

<div id="userName">🔄 載入中...</div>

<form id="campForm">
  <label for="name">填寫者姓名</label>
  <input type="text" id="name" name="name" placeholder="自動帶入 LINE 名稱" readonly required>

  <label for="campName">露營場次名稱</label>
  <input type="text" id="campName" name="campName" placeholder="請輸入露營場次名稱" required>

  <label for="adults">大人人數</label>
  <input type="number" id="adults" name="adults" placeholder="請輸入大人人數" min="0" required>

  <label for="halfPriceKids">半價小孩人數</label>
  <input type="number" id="halfPriceKids" name="halfPriceKids" placeholder="請輸入半價小孩人數" min="0" required>
  <div class="hint">小1以上到高中，沒有則填 0</div>

  <label for="freeKids">幼稚園以下小孩人數</label>
  <input type="number" id="freeKids" name="freeKids" placeholder="請輸入幼稚園以下小孩人數" min="0" required>
  <div class="hint">沒有則填 0</div>

  <label>是否夜衝</label>
  <div class="checkbox-group">
    <input type="checkbox" id="nightRush" name="nightRush">
    <label for="nightRush">是</label>
  </div>

  <button type="submit">送出報名</button>
</form>

<script>
const liffId = "YOUR_LIFF_ID_HERE";   // 替換成你的 LIFF ID
const NOTION_API_KEY = "YOUR_NOTION_API_KEY_HERE"; // Notion API Key
const DATABASE_ID = "YOUR_DATABASE_ID_HERE";      // Notion Database ID

async function initLIFF() {
  await liff.init({ liffId });

  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  try {
    const profile = await liff.getProfile();
    const nameInput = document.getElementById("name");
    nameInput.value = profile.displayName; // 將 LINE 名稱填入 input
    document.getElementById("userName").textContent = `👤 目前登入者：${profile.displayName}`;
  } catch (err) {
    document.getElementById("userName").textContent = "⚠️ 無法取得使用者資訊";
    console.error(err);
  }
}

// 表單送出
document.getElementById("campForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = document.getElementById("name").value;
  const campName = document.getElementById("campName").value;
  const adults = parseInt(document.getElementById("adults").value) || 0;
  const halfPriceKids = parseInt(document.getElementById("halfPriceKids").value) || 0;
  const freeKids = parseInt(document.getElementById("freeKids").value) || 0;
  const nightRush = document.getElementById("nightRush").checked;

  try {
    const res = await fetch("https://api.notion.com/v1/pages", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${NOTION_API_KEY}`,
        "Content-Type": "application/json",
        "Notion-Version": "2022-06-28"
      },
      body: JSON.stringify({
        parent: { database_id: DATABASE_ID },
        properties: {
          "露營場次名稱": { title: [{ text: { content: campName } }] },
          "填寫者名稱": { rich_text: [{ text: { content: name } }] },
          "大人人數": { number: adults },
          "半價小孩人數": { number: halfPriceKids },
          "幼稚園以下人數": { number: freeKids },
          "是否夜衝": { checkbox: nightRush }
        }
      })
    });

    if (!res.ok) {
      const errData = await res.json();
      console.error("Notion API Error:", errData);
      alert("❌ 報名失敗，請稍後再試！");
      return;
    }

    alert("✅ 報名成功！");
    liff.closeWindow();

  } catch (err) {
    console.error("Error submitting form:", err);
    alert("❌ 系統發生錯誤，請稍後再試！");
  }
});

initLIFF();
</script>
</body>
</html>
